(function ($) {
    var DymAddress = function (options, $element) {
        this.options = options || {};
        this.province = "";
        this.city = "";
        this.region = "";
        this.provinceId = "";
        this.cityId = "";
        this.regionId = "";
        this.h_provinceIndex = 0;
        this.h_cityIndex = 0;
        this.h_regionIndex = 0;
        this.proSwiper = null;
        this.citySwiper = null;
        this.regionSwiper = null;
        this.$element = $element;
        this.title = this.options.title || "选择地址";
        this.isSecondLevel = this.options.isSecondLevel || false;
        this._complete = this.options.complete || function () {
                return true;
            };
        this._cancel = this.options.cancel || function () {
            };
        this._oninit = this.options.onInit || function () {
            };
        this._onProvinceChange = this.options.onProvinceChange || function () {
            };
        this._onCityChange = this.options.onCityChange || function () {
            };
        this._getProvinceList = this.options.getProvinceList || function () {
            };
        this._getCityList = this.options.getCityList || function () {
            };
        this._getRegionList = this.options.getRegionList || function () {
            };
        this._getRegionList = !this.isSecondLevel ? this.options.getRegionList : function () {
        };

        this.$work = $("<div class='dym-address-picker'><div class='dym-address-area'>" +
            "<div class='title'>" +
            "<div class='cancel'><div class='bg'></div></div>" +
            "<div class='inner'>" + this.title + "</div>" +
            "<div class='complete'><div class='bg'></div></div>" +
            "</div>" +
            "<div class='main-container'></div>" +
            "</div></div>");

        this.$address = $("<div class='dym-address'></div>");

        var self = this;
        this.$work.find(".cancel").off("click").on("click", function () {
            self.showByIndex(self.h_provinceIndex, self.h_cityIndex, self.h_regionIndex);
            self._cancel();
            self.hide();
        });

        this.$work.find(".complete").off("click").on("click", function () {
            var flag = self._complete(self.getInfo());
            if (flag) {
                self.hide();
            }
            self.h_provinceIndex = self.proSwiper.activeIndex;
            self.h_cityIndex = self.citySwiper.activeIndex;
            self.h_regionIndex = self.regionSwiper.activeIndex;
        });

        this.init();
        this.hide();
    };

    DymAddress.prototype.init = function () {
        this.initFrame();
        this.$work.find(".main-container").append(this.$address);
        this.$element.append(this.$work);
        var self = this;
        var proInitFlag = false, cityInitFlag = false, regionInitFlag = false;
        var doCallback = function () {
            self._oninit();
            self.hide();
        };
        this.proSwiper = new Swiper(this.$work.find('.address-province .warp'), {
            direction: 'vertical',
            loop: false,
            slidesPerView: 5,
            onInit: function (swiper) {
                self.provinceId = $(swiper.slides[swiper.activeIndex]).data("value") || "";
                self.province = $(swiper.slides[swiper.activeIndex]).html() || "";
                proInitFlag = true;
            },
            onSlideChangeEnd: function (swiper) {
                self.provinceId = $(swiper.slides[swiper.activeIndex]).data("value") || "";
                self.province = $(swiper.slides[swiper.activeIndex]).html() || "";
                self.city = "";
                self.region = "";
                self.refreshCityRegion();
                self._onProvinceChange(self.province);
                
                self.h_provinceIndex = swiper.activeIndex;
               
            },
            centeredSlides: true
        });

        this.citySwiper = new Swiper(this.$work.find('.address-city .warp'), {
            direction: 'vertical',
            loop: false,
            slidesPerView: 5,
            onInit: function (swiper) {
                self.cityId = $(swiper.slides[swiper.activeIndex]).data("value") || "";
                self.city = $(swiper.slides[swiper.activeIndex]).html() || "";
                cityInitFlag = true;
            },
            onSlideChangeEnd: function (swiper) {
                self.cityId = $(swiper.slides[swiper.activeIndex]).data("value") || "";
                self.city = $(swiper.slides[swiper.activeIndex]).html() || "";
                self.region = "";
                self.refreshRegion();
                self._onCityChange(self.province, self.city);
                self.h_cityIndex = swiper.activeIndex;
            },
            centeredSlides: true
        });

        this.regionSwiper = new Swiper(this.$work.find('.address-region .warp'), {
            direction: 'vertical',
            loop: false,
            slidesPerView: 5,
            onInit: function (swiper) {
                self.regionId = $(swiper.slides[swiper.activeIndex]).data("value") || "";
                self.region = $(swiper.slides[swiper.activeIndex]).html() || "";
                regionInitFlag = true;
            },
            onSlideChangeEnd: function (swiper) {
                self.regionId = $(swiper.slides[swiper.activeIndex]).data("value") || "";
                self.region = $(swiper.slides[swiper.activeIndex]).html() || "";
                self.h_regionIndex = swiper.activeIndex;

            },
            centeredSlides: true
        });

        doCallback();
    };

    DymAddress.prototype.initFrame = function () {
        var $province = $("<div class='address-province'>" +
            "<div class=\"select\"></div>" +
            "<div class='warp'>" +
            "<div class='swiper-wrapper'></div>" +
            "</div>" +
            "</div>");

        var $city = $("<div class='address-city'>" +
            "<div class=\"select\"></div>" +
            "<div class='warp'>" +
            "<div class='swiper-wrapper'></div>" +
            "</div>" +
            "</div>");

        var $region = $("<div class='address-region'>" +
            "<div class=\"select\"></div>" +
            "<div class='warp'>" +
            "<div class='swiper-wrapper'></div>" +
            "</div>" +
            "</div>");

        if (this.isSecondLevel) {
            $province.addClass("second");
            $city.addClass("second");
            $region.addClass("second");
        }

        var self = this;
        self._getProvinceList(function (proList) {

            self.initProvice($province, proList);
            self.$address.append($province);

            if (proList.length == 0) {
                proList.push("北京");
            }

            self._getCityList(proList[0].id, function (cityList) {
                self.initCity($city, cityList);
                self.$address.append($city);

                if (cityList.length == 0) {
                    cityList.push(proList[0]);
                }

                self._getRegionList(proList[0].id, cityList[0].id, function (regionList) {
                    self.initRegion($region, regionList);
                    self.$address.append($region);
                });
            });
        });
    };

    DymAddress.prototype.initProvice = function ($province, list) {
        $province.find(".swiper-wrapper").empty();
        if (!list) {
            return;
        }
        for (var i = 0; i < list.length; i++) {
            $province.find(".swiper-wrapper").append("<div class='swiper-slide' data-value='" + (list[i].id) + "'>" + (list[i].name) + "</div>");
        }
    };

    DymAddress.prototype.initCity = function ($city, list) {
        $city.find(".swiper-wrapper").empty();
        if (!list) {
            return;
        }
        for (var i = 0; i < list.length; i++) {
            $city.find(".swiper-wrapper").append("<div class='swiper-slide' data-value='" + (list[i].id) + "'>" + (list[i].name) + "</div>");
        }
    };

    DymAddress.prototype.initRegion = function ($region, list) {
        if (this.isSecondLevel) return;
        $region.find(".swiper-wrapper").empty();
        if (!list) {
            return;
        }
        for (var i = 0; i < list.length; i++) {
            $region.find(".swiper-wrapper").append("<div class='swiper-slide' data-value='" + (list[i].id) + "'>" + (list[i].name) + "</div>");
        }
    };

    DymAddress.prototype.showByIndex = function (provinceIndex, cityIndex, regionIndex) {
        provinceIndex = provinceIndex || 0;
        cityIndex = cityIndex || 0;
        regionIndex = regionIndex || 0;
        var self = this;
        this.proSwiper.slideTo(provinceIndex);

        self.provinceId = $(self.proSwiper.slides[self.proSwiper.activeIndex]).data("value") || "";
        self.province = $(self.proSwiper.slides[self.proSwiper.activeIndex]).html() || "";

        self._getCityList(self.provinceId, function (cityList) {
            self.initCity(self.$work.find(".address-city"), cityList);
            self.citySwiper.update(true);
            self.citySwiper.slideTo(cityIndex);
            self.cityId = $(self.citySwiper.slides[self.citySwiper.activeIndex]).data("value") || "";
            self.city = $(self.citySwiper.slides[self.citySwiper.activeIndex]).html() || "";

            self._getRegionList(self.provinceId, self.cityId, function (regionList) {
                self.initRegion(self.$work.find(".address-region"), regionList);
                self.regionSwiper.update(true);
                self.regionSwiper.slideTo(regionIndex);
                self.regionId = $(self.regionSwiper.slides[self.regionSwiper.activeIndex]).data("value") || "";
                self.region = $(self.regionSwiper.slides[self.regionSwiper.activeIndex]).html() || "";
            });
        });
    };

    DymAddress.prototype.refreshCityRegion = function () {
        var self = this;
        self._getCityList(self.provinceId, function (cityList) {
            self.initCity(self.$work.find(".address-city"), cityList);
            self.citySwiper.update(true);
            self.cityId = $(self.citySwiper.slides[self.citySwiper.activeIndex]).data("value") || "";
            self.city = $(self.citySwiper.slides[self.citySwiper.activeIndex]).html() || "";

            self._getRegionList(self.provinceId, self.cityId, function (regionList) {
                self.initRegion(self.$work.find(".address-region"), regionList);
                self.regionSwiper.update(true);
                self.regionId = $(self.regionSwiper.slides[self.regionSwiper.activeIndex]).data("value") || "";
                self.region = $(self.regionSwiper.slides[self.regionSwiper.activeIndex]).html() || "";
            });
        });
    };

    DymAddress.prototype.refreshRegion = function () {
        var self = this;
        self._getRegionList(self.provinceId, self.cityId, function (regionList) {
            self.initRegion(self.$work.find(".address-region"), regionList);
            self.regionSwiper.update(true);
            self.regionId = $(self.regionSwiper.slides[self.regionSwiper.activeIndex]).data("value") || "";
            self.region = $(self.regionSwiper.slides[self.regionSwiper.activeIndex]).html() || "";
        });
    };

    DymAddress.prototype.show = function () {
        this.$work.show();
        this.showByIndex(this.h_provinceIndex, this.h_cityIndex, this.h_regionIndex);
        this.proSwiper.update(true);
        this.citySwiper.update(true);
        if (!this.isSecondLevel) {
            this.regionSwiper.update(true);
        }

    };

    DymAddress.prototype.hide = function () {
        this.$work.hide();
    };

    DymAddress.prototype.getInfo = function () {
        return {
            province: this.province,
            city: this.city,
            region: this.region,
            provinceId: this.provinceId,
            cityId: this.cityId,
            regionId: this.regionId,
            region_id_list: this.h_provinceIndex + "_" + this.h_cityIndex + "_" + this.h_regionIndex
        }
    };

    $.fn.address = function (options) {
        var $element = $(this);
        return new DymAddress(options, $element);
    }
})(Zepto);